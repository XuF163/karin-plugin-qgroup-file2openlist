# 二期工程计划：主人私聊 · 图片交互增强（`karin-plugin-qgroup-file2openlist`）

> 本文档是二期的“开发执行清单”。遵循：**先规划 → 你确认 → 再落地代码**。  
> 参考风格：Yunzai / miao-plugin（MIT，允许复用；如拷贝其模板/CSS，将在仓库内保留许可声明）。

## 0. 二期目标与边界

### 0.1 目标（你已确认）

- 仅限 **主人**、仅限 **私聊**：提供更丰富的“图片面板/图片结果卡”，用于管理与查看：
  - 备份群绑定（绑定/解绑）
  - 群文件上传监听开关（默认：绑定即开启）
  - OpenList → OpenList 转发规则（多源站、单目的端）
- 图片风格参考 miao-plugin：卡片化、信息密度高、适合手机竖屏阅读（**1080p+**）。
- 图片输出 **不强制打码**（群号/地址可直接展示）。

### 0.2 边界（本期不做/暂不做）

- 不做“多目的端”（同一规则转发到多个目标 OpenList）。
- OpenList 转发：**默认只保存规则 + 手动触发**；默认触发为**全量**（后续可扩展定时）。
- 不做群聊交互（避免刷屏、避免误触发）。

### 0.3 复用现状（本仓库已有）

- 图片渲染：`node-karin` 的 `render.render()`（基于 puppeteer），支持 `setViewport`/`fullPage`/`multiPage`，模板参数为 **art-template**。
  - 现有示例：`src/apps/help.ts` + `resources/template/help.html`
- 群同步与监听能力：
  - 同步：`src/model/groupFiles/syncToOpenList.ts`
  - 上传监听自动备份：`src/model/groupFiles/uploadAutoBackup.ts`（由 `notice.groupFileUploaded` 触发）
  - 群同步配置：`groupSyncTargets[]`（WebUI/指令都能写入）
- OpenList → OpenList 备份核心：`src/model/openlist/backup.ts`（当前源端默认 guest，可按需扩展源端账号）

## 1. 用户交互设计（命令 + 图片）

> 所有命令：`permission: 'master'` 且 `e.isPrivate === true`。  
> 所有命令：优先返回**图片结果卡**；长任务可“文字进度 + 图片总结”。

### 1.1 总览面板（建议新增）

#### `#群文件面板`

输出竖版“控制台”图片（1080×1920 或更高），包含：

- OpenList 目标端摘要（baseUrl/username/targetDir）
- 群绑定列表（groupId、启用状态、uploadBackup、mode、目标目录、最近同步时间）
- OP 转发规则摘要（ruleId、源站、srcDir、toDir、上次执行结果/时间）
- 常用快捷命令提示（可复制）

可选分页：

- `#群文件面板 2`：查看第 2 页（或使用 `--page 2`）

### 1.2 群绑定（绑定即开启监听）

#### `#绑定备份群 <群号> [--to <dir>] [--flat|--keep]`

行为：

1. 在配置 `groupSyncTargets` 中 **upsert** 该群：
   - `enabled = true`
   - `uploadBackup = true`（绑定即开启监听，符合你要求）
   - `targetDir`：默认 `openlistTargetDir/<groupId>`，可用 `--to` 覆盖
   - `mode`：固定增量（incremental，不再通过命令配置）
   - `flat`：默认走 `groupSyncDefaults`，可用参数覆盖
2. 回复“绑定成功”图片卡：
   - 展示该群关键策略（目标目录、模式、并发/超时等取最终生效值）
   - 给出下一步快捷命令：`#同步群文件 <群号>`、`#解绑备份群 <群号>` 等

> 备注：当前实现中，`#同步群文件` 已固定为增量（incremental）+ 单文件超时 3000s，不再区分“是否已配置该群”。

#### `#解绑备份群 <群号>`

你已确认：**解绑 = 删除群配置**。

行为：

1. 从 `groupSyncTargets` 中删除该群条目。
2.（建议）同时可选清理同步状态文件：
   - 默认：不强制清理（避免误删历史）
   - 若你希望解绑后也删除状态：可约定 `--purge-state`
3. 回复“解绑完成”图片卡（展示删除前摘要 + 删除后提示）。

### 1.3 群文件监听开关

#### `#开启群文件监听 <群号>`

- 若该群不存在配置：自动创建默认条目（等同“绑定备份群”，并 `uploadBackup=true`）。
- 若存在：只切 `uploadBackup=true`。
- 回复图片卡：显示开关状态与生效说明（监听事件为 `notice.groupFileUploaded`）。

#### `#关闭群文件监听 <群号>`

- 若该群不存在配置：回复“未绑定/无配置”的图片提示。
- 若存在：切 `uploadBackup=false`。
- 回复图片卡。

### 1.4 OpenList 转发规则（多源站，单目的端）

#### 1.4.1 规则定义（核心）

- 多源站：可以保存多条规则，每条规则有一个 `sourceBaseUrl`。
- 单目的端：目标端固定使用插件配置 `openlistBaseUrl/openlistUsername/openlistPassword`。

#### 1.4.2 命令设计

##### `#添加op转发 <源OpenListBaseUrl> [--src <dir>] [--to <dir>] [--name <别名>] [--inc|--full] [--auto|--api|--webdav]`

- 默认 `--full`（你已确认）
- 默认传输 `auto`
- 默认 `--src /`
- 默认 `--to`：使用 `openlistTargetDir`（实际落盘路径仍会在目标端自动创建“源域名子目录”，沿用 `backup.ts` 的策略）
- 可选：如果你确实还会手滑输入两个 URL（源/目的），本期建议直接报错并提示“目的端固定为配置 openlistBaseUrl=xxx”（避免误解）。

输出：规则创建成功图片卡（含 ruleId 与下一步命令：执行/查看/删除）。

##### `#op转发 列表`

输出：规则列表图片（ruleId、name、sourceBaseUrl、srcDir、toDir、mode、transport、lastRunAt/lastResult）。

##### `#op转发 查看 <ruleId>`

输出：单条规则详情图片（完整参数 + 目的端信息 + 最近一次执行信息）。

##### `#op转发 执行 <ruleId> [--inc|--full]`

你已确认：默认全量。

执行策略：

- 立即回复一张“任务已启动”图片卡（包含本次参数快照）。
- 运行过程中：
  - 可用文字 `report` 输出阶段性进度（每 10s 一条即可，避免刷屏）。
  - 最终输出“执行结果”图片卡（成功/跳过/失败统计、耗时、失败示例前 N 条）。

##### `#op转发 删除 <ruleId>`

删除该规则并返回图片卡（展示删除前摘要）。

#### 1.4.3 源端鉴权（是否做进二期）

现有 `backup.ts` 源端默认 guest（token 为空）。  
二期建议直接支持可选源端账号（否则“多源站”很容易遇到私有源站不可用）：

- 命令加可选参数：`--user <u> --pass <p>`
- 配置规则字段保存：`sourceUsername/sourcePassword`
- 备份执行时：
  - 源端 API：若提供账号则 `openlistApiLogin()` 获取 token；否则 guest
  - 源端 WebDAV：若传输选择 webdav，则使用 BasicAuth

> 你已说明“图片输出不必打码”，但仍建议默认不在图片中直接展示 `password`（只展示“已配置/未配置”），避免复制转发造成泄露；如你坚持展示，可加 `--show-secret`。

## 2. 配置与数据结构设计

### 2.1 配置文件位置（沿用现状）

- 生效配置：`@karinjs/<插件包名>/config/config.json`
- 默认配置：`config/config.json`
- 合并：浅合并（数组整体替换）

### 2.2 新增配置字段（建议）

在 `config/config.json` 增加空数组占位（不破坏现有逻辑）：

```jsonc
{
  "openlistForwardRules": []
}
```

规则结构（建议 schema，字段可逐步落地）：

```ts
type OpenListForwardRule = {
  id: string                 // 稳定标识（建议短ID，便于手输）
  name?: string              // 备注/别名

  sourceBaseUrl: string
  sourceUsername?: string
  sourcePassword?: string

  srcDir?: string            // 默认 '/'
  toDir?: string             // 默认使用 openlistTargetDir

  mode?: 'full' | 'incremental'                 // 默认 full
  transport?: 'auto' | 'webdav' | 'api'         // 默认 auto

  concurrency?: number        // 默认 3（复制并发）
  scanConcurrency?: number    // 默认 20（扫描并发）
  perPage?: number            // 默认 1000（API list per_page）
  timeoutSec?: number         // 默认 600（单文件超时）

  lastRunAt?: number
  lastResult?: { ok: number, skipped: number, fail: number }
  createdAt?: number
  updatedAt?: number
}
```

> WebUI 当前写配置时会 `next = { ...def, ...current }`，不会主动删除未知字段，因此新增字段不会被 WebUI 误删。

### 2.3 群绑定字段落点（沿用现状）

不新增字段，复用：

- `groupSyncTargets[]`（新增/删除条目）
- `uploadBackup`（监听开关）

## 3. 渲染模板方案（miao 风格）

### 3.1 模板引擎与渲染参数

- 使用 `render.render({ file, data, setViewport, type, encoding })`
- `data` 直接传给 art-template，可用：
  - `{{each list}}...{{/each}}`
  - `{{if ...}}...{{/if}}`
  - `{{@html}}` 输出不转义内容

### 3.2 分辨率与适配

主方案：竖屏 1080p+

- `setViewport: { width: 540, height: 960, deviceScaleFactor: 2 }` → 1080×1920

列表过长：

- 方案A（推荐）：`multiPage: 960` 自动分页，返回图片数组，逐张发送
- 方案B：命令级分页（`--page`/`--size`），单张图展示固定条数

### 3.3 资源组织（建议）

已落地目录（本期实际落地）：

```
resources/
  template/
    ui/
      panel.html              # #群文件面板
      action-result.html      # 通用结果卡（绑定/解绑/监听/op转发等）
```

说明：当前模板为“参考 miao 风格后自写”，未直接拷贝其 CSS/布局代码；如后续复用 miao-plugin 片段，请在模板/CSS 顶部注明来源，并保留其 MIT 许可声明。

## 4. 代码模块与改动点（已落地）

> 目标：保持 `apps` 薄、逻辑下沉到 `model`，符合当前仓库的重构约定。

### 4.1 新增/调整的模块（本期落地）

- `src/model/shared/pluginConfig.ts`
  - 统一读写 `@karinjs/<plugin>/config/config.json`
  - 提供 `readMergedConfig()`、`updateRuntimeConfig(fn)`（默认配置 + 运行时配置浅合并）
- `src/model/ui/render.ts`
  - 统一 `ensurePluginResources()` + `render.render()` 调用
  - 提供 `renderUiPngBase64()`（支持 `multiPage`，返回 base64 PNG 或数组）
- `src/model/groupSync/bindings.ts`
  - `bindBackupGroup()` / `unbindBackupGroup()` / `setGroupUploadBackup()`
  - 内部操作 `groupSyncTargets`
- `src/model/openlistForward/*`
  - `types.ts`（OpenListForwardRule）
  - `store.ts`（增删改查规则）
  - `run.ts`（调用 `backupOpenListToOpenListCore` 执行规则，并记录 lastRun）
- `src/apps/ownerUi.ts`
  - 注册上述命令：面板/绑定/解绑/监听/op转发

### 4.2 对现有代码的预期改动

- `src/model/openlist/backup.ts`
  - 可选扩展：支持源端账号（不破坏现有命令 `#备份oplist` 的行为）
- `src/utils/config.ts`
  - 类型补全：新增 `openlistForwardRules` 字段（不影响运行）
- `config/config.json`
  - 默认增加 `openlistForwardRules: []`

## 5. 开发里程碑（按执行顺序）

### M1：渲染基建 + 面板模板（图片风格定稿）

- 完成通用 render 封装与 1080p 竖版模板体系
- 实现 `#群文件面板`（只读展示）
- 验收：面板在手机上可读、信息密度合理、长列表能分页

### M2：群绑定/监听开关（图片结果卡）

- 实现：`#绑定备份群` / `#解绑备份群` / `#开启群文件监听` / `#关闭群文件监听`
- 验收：配置写入正确、监听立即生效、输出图片准确

### M3：op转发规则（保存/查看/执行/删除）

- 实现：规则 CRUD（写入 config）+ 手动执行（默认全量）
- 可选：源端账号支持
- 验收：多源站可存多条；执行结果可追踪（lastRunAt/lastResult）

### M4：打磨与文档

- 为所有新命令补齐 `--help` 文本
- 增补 `docs/开发文档.md` 的“二期新增命令/配置字段”章节
- 清理不必要日志/噪音（可选）

## 6. 验收清单（你确认后我按此逐项交付）

- [ ] 所有二期命令仅主人私聊可用
- [ ] `#绑定备份群` 会写入 groupSyncTargets，并默认开启 uploadBackup
- [ ] `#解绑备份群` 会删除 groupSyncTargets 条目（可选清理 state）
- [ ] `#开启/关闭群文件监听` 只影响 uploadBackup
- [ ] `#添加op转发` 可保存多条源站规则（单目的端固定为配置）
- [ ] `#op转发 执行` 默认全量，能输出最终图片总结
- [ ] 图片竖版 1080p+，长列表可分页输出
