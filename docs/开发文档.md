# `karin-plugin-qgroup-file2openlist` 开发文档（交接版）

> 目标：基于仓库**当前实际代码**整理一套可落地的开发/维护文档（功能、配置、目录结构、关键流程、数据落盘、排障）。

## 目录

- [1. 项目概览](#1-项目概览)
- [2. 已实现功能清单（项目现状）](#2-已实现功能清单项目现状)
- [3. 目录结构与职责划分](#3-目录结构与职责划分)
- [4. 开发与运行](#4-开发与运行)
- [5. 配置说明](#5-配置说明)
- [6. 指令与事件（对外行为）](#6-指令与事件对外行为)
- [7. 数据落盘与文件格式](#7-数据落盘与文件格式)
- [8. 关键实现细节（维护者必读）](#8-关键实现细节维护者必读)
- [9. 常见问题与排障](#9-常见问题与排障)
- [10. 后续开发建议（按当前代码的“最值钱”改进项）](#10-后续开发建议按当前代码的最值钱改进项)

## 1. 项目概览

### 1.1 插件做什么

本插件围绕「QQ群文件」提供三类能力：

1. **群文件导出**：递归遍历群文件目录树，导出 JSON/CSV（可选解析下载 URL）。
2. **同步到 OpenList（目标端）**：把群文件下载后上传到 OpenList WebDAV 目录（支持全量/增量、并发、限速、超时、重试、进度播报）。
3. **备份与自动备份**：
   - OpenList → OpenList 备份（源端“guest/公开访问”扫描 + 目标端上传，支持 API/WebDAV/auto）。
   - 监听群文件上传事件，自动备份新文件到 OpenList（按群串行队列，避免并发过高）。

### 1.2 当前版本/包信息（以仓库为准）

- npm 包名：`karin-plugin-qgroup-file2openlist`（见 `package.json`）
- 当前版本：`0.0.22`（见 `package.json`）
- 模块类型：ESM（`"type": "module"`）
- 构建工具：`tsup`（输出到 `lib/`）
- 运行框架：`node-karin`
- 渲染依赖：`@karinjs/plugin-puppeteer`（用于 `#群文件帮助` 这类 HTML → 图片渲染）

### 1.3 “运行时目录”是什么

插件运行时会把配置、数据、资源落到 Karin 的 `@karinjs` 目录（由 `node-karin` 提供的 `karinPathBase` 决定）。

本仓库中已存在一个 `@karinjs/` 目录（用于本地运行/调试），典型结构如下：

```
@karinjs/
  karin-plugin-qgroup-file2openlist/
    config/config.json        # 运行时配置（会从包内 config/config.json 初始化/合并）
    data/                     # 导出结果、增量同步状态等
    resources/                # 运行时资源（help.html 等会被复制到这里）
```

> 关键点：开发/排障时，**一定要区分**「仓库内的默认配置」vs「运行时实际生效的配置」。

## 2. 已实现功能清单（项目现状）

### 2.1 核心功能（可用）

- 群文件导出（私聊指令）：`#导出群文件 <群号> [--csv] [--no-url] [--url-only] [--folder <id>] [--max <n>] [--concurrency <n>] [--send-file]`
- 群文件同步到 OpenList（私聊指令）：`#同步群文件 <群号> [--to <dir>] [--flat|--keep] [--folder <id>] [--max <n>] [--concurrency <n>]`（固定：增量 + 单文件超时 3000s）
- 群同步配置（私聊/主人权限）：`#群同步配置 列表|查看|添加|删除|启用|停用|...`
- 夜间自动备份调度（后台任务）：按 `config.scheduler.tickCron` 触发（默认每天 02:00），先群后 oplts，并受 `timeWindows` 限制
- OpenList → OpenList 备份（私聊指令）：`#备份oplist <源OpenList地址> [--src] [--to] [--api|--webdav|--auto] ...`（固定：增量 + 单文件超时 3000s）
- 群文件上传自动备份（事件）：监听 `notice.groupFileUploaded`，按 `groupSyncTargets[].uploadBackup` 开关执行
- 帮助图（私聊指令）：`#群文件帮助`（HTML 模板渲染成竖版图片）

### 2.2 运行/维护相关能力（可用）

- 默认配置自动初始化：`src/utils/config.ts` 会把包内 `config/` 复制到运行时目录 `@karinjs/<plugin>/config/`
- WebUI 配置页：`src/web.config.ts`（可在 Karin WebUI 中填写 OpenList 与群同步策略）
- 错误信息尽量可读：`src/model/shared/errors.ts` 统一格式化各种异常

### 2.3 “遗留/模板代码”现状（如需精简）

`src/apps/` 下存在若干模板示例代码（如渲染 demo、主动消息 demo、定时任务 demo、handler demo），部分指令正则中混入了随机字符串（降低误触发概率），但它们仍会被加载：

- `src/apps/example.ts`
- `src/apps/render.ts`
- `src/apps/sendMsg.ts`
- `src/apps/task.ts`
- `src/apps/handler.ts`

它们目前包含的“可被正常触发”的行为（非核心能力，但会影响实际运行）示例：

- `src/apps/sendMsg.ts`：
  - `#一言`：按 `config.yiyanApi` 返回一张图（外部 URL）
  - `#测试转发` / `#随机表情` / `#每日一言` / `#今日天气`：demo 功能
- `src/apps/render.ts`：
  - `#渲染 ...`：非常宽泛的前缀匹配（`/^#?渲染/`），主人权限；可能与其他插件指令产生冲突
  - `#测试截图`：依赖 `config.screenshotUrl`（当前默认配置未提供该字段，使用时可能报错）
- `src/apps/task.ts`：
  - 定时任务「每分钟的趣味问候」：每分钟打印日志（生产环境可能造成噪音）

交接建议：

- 如果这是生产插件仓库：建议后续将这些 demo 移出默认加载路径（或显式用配置开关控制），避免误触发/误维护成本。
- 如果这是学习/模板仓库：保留也可以，但请在文档里明确它们“不是核心功能”。

## 3. 目录结构与职责划分

### 3.1 代码目录（关键）

```
src/
  app.ts                      # 本地启动入口（dev 时会准备插件 stub，再 import 'node-karin/start'）
  index.ts                    # 插件初始化日志（不写业务逻辑）
  dir.ts                      # 运行时路径计算（@karinjs/.../config|data|resources）
  web.config.ts               # Karin WebUI 插件配置页（读写 config.json）

  apps/                       # “薄层”：命令匹配/参数解析/权限/回复消息
    groupFiles.ts             # #导出群文件、#同步群文件
    groupFiles.backup.ts      # #备份oplist + 上传自动备份事件
    groupSyncConfig.ts        # #群同步配置（主人权限）
    scheduler.ts              # 定时任务统一调度器（群同步 + oplts 夜间）
    help.ts                   # #群文件帮助（渲染 help.html 为图片）
    ownerUi.ts                # 二期：主人私聊图片面板（群绑定/监听/OP转发）
    ...（其余为 demo/模板）

  model/                      # “业务层”：可复用、可测试、与 event 解耦
    groupFiles/               # 群文件领域：遍历、URL解析、导出、同步、状态、上传自动备份
    groupSync/                # 群同步：配置命令处理 + 定时调度逻辑
      bindings.ts             # 二期：群绑定/解绑/监听开关（写 groupSyncTargets）
    openlist/                 # OpenList：API/WebDAV/备份（OpenList->OpenList）
    openlistForward/          # 二期：OpenList -> OpenList 转发规则（多源站 -> 单目的端）
    ui/                       # 二期：图片 UI 渲染封装（模板 -> PNG base64）
    shared/                   # 通用：并发、重试、限速、路径处理、fs-json、错误格式化
      pluginConfig.ts         # 二期：运行时配置读写封装（默认配置 + 运行时配置）

config/
  config.json                 # 包内默认配置（会复制到运行时目录）

resources/
  template/help.html          # 帮助图 HTML 模板（会复制到运行时目录）
  template/test.html          # 渲染 demo 模板
  template/ui/*               # 二期：主人私聊“面板/结果卡”模板
  image/启程宣发.png           # 渲染 demo 图片

lib/
  ...                         # tsup 构建产物（发布/运行时用）
```

### 3.2 apps vs model 的依赖方向（当前约定）

- `src/apps/*`：
  - 只做：命令/事件注册、参数解析、权限判断、把进度/结果通过 `e.reply()` 输出
  - 不做：OpenList API/WebDAV、群文件遍历、并发/重试算法等核心逻辑
- `src/model/*`：
  - 负责：业务流程 + 网络/文件系统边界 + 状态管理
  - 能力可被：命令调用、定时任务调用、事件回调调用

这套分层已在 `docs/refactor-plan.md` 中做过更细的拆分说明（并已落地）。

## 4. 开发与运行

### 4.1 环境要求（以代码/构建配置为准）

- Node.js：建议 `>= 18`（`tsup.config.ts` 目标为 `node18`）
- 包管理：仓库存在 `pnpm-lock.yaml`，推荐 `pnpm`；也兼容 `npm`
- 运行框架：`node-karin`
- 如使用“帮助图渲染”：需要 `@karinjs/plugin-puppeteer` 正常安装（可能会下载 Chromium）

### 4.2 常用脚本（`package.json`）

- `pnpm dev`：开发运行（实际命令：`cross-env EBV_FILE="development.env" node --import tsx src/app.ts`）
- `pnpm build`：构建到 `lib/`（`tsup`）
- `pnpm app`：运行构建产物（`node lib/app.js`）
- `pnpm pub`：发布 npm（`npm publish --access public`）

> 说明：`development.env`/`.env` 为 `node-karin` 运行时环境配置样例（HTTP/Redis/日志等级等）。

### 4.3 本地跑起来（最小步骤）

1. 安装依赖：`pnpm install`
2. 开发模式启动：`pnpm dev`
3. 首次启动后观察：
   - 是否生成/更新 `@karinjs/<插件名>/config/config.json`
   - 日志是否提示插件初始化完成（见 `src/index.ts`）
4. 填写 OpenList 配置：
   - 直接改 `@karinjs/<插件名>/config/config.json`
   - 或在 Karin WebUI 的插件配置页填写（`src/web.config.ts`）

### 4.4 发布与运行时加载（仓库侧能确认的部分）

插件包通过 `package.json#karin` 字段声明 Karin 入口：

- `main`: `src/index.ts`（构建后为 `lib/index.js`）
- apps：
  - `apps`: `lib/apps`（构建后 JS apps）
  - `ts-apps`: `src/apps`（TS apps，便于开发调试）
- WebUI：
  - `web`: `lib/web.config.js`
  - `ts-web`: `src/web.config.ts`
- 静态资源：`resources/`
- 随包文件：`config/`、`data/`、`resources/`

> 注意：不同 Karin 部署方式可能影响 `@karinjs` 目录的位置；本插件通过 `src/dir.ts` 统一获取运行时目录，不应在业务代码里硬编码绝对路径。

## 5. 配置说明

### 5.1 配置文件位置与合并规则

运行时读取的配置由 `src/utils/config.ts` 提供：

- **默认配置（包内）**：`config/config.json`
- **运行时配置（生效）**：`@karinjs/<插件名>/config/config.json`
- `config()` 返回：`{ ...默认配置, ...运行时配置 }`（浅合并）

> 结论：运行时配置只需要覆盖你关心的字段；未填写的字段会从默认配置补齐。

补充说明（维护者注意）：

- **浅合并**：对象是浅层覆盖，数组会整体替换；如果你只想改 `groupSyncTargets` 里某一项，最好用 WebUI 或 `#群同步配置` 指令更新，避免手工编辑把其它项覆盖掉。
- **敏感信息**：`openlistPassword` 会以明文写入 `config.json`。另外 `src/utils/config.ts` 有文件监听日志，会把 old/now 全量打印到日志中（可能包含密码），生产环境建议后续做脱敏/关闭该日志。

### 5.2 配置字段（当前代码使用到的）

默认配置样例见 `config/config.json`。

#### OpenList（目标端）

- `openlistBaseUrl`：OpenList 基础地址，例如 `http://127.0.0.1:5244`
- `openlistUsername` / `openlistPassword`：用于 WebDAV BasicAuth
- `openlistTargetDir`：默认目标目录（posix path），例如 `/挂载目录/QQ群文件`

#### 群同步默认策略 `groupSyncDefaults`

用于 `#同步群文件` 未显式传参、且 `groupSyncTargets` 未覆盖时的默认值：

- `mode`: `'full' | 'incremental'`
- `flat`: 是否平铺上传（不保留目录结构）
- `urlConcurrency`: 解析群文件下载 URL 的并发
- `transferConcurrency`: 下载+上传的并发
- `fileTimeoutSec`: 单文件总超时（下载+上传），上限 3000 秒
- `retryTimes`: 单文件失败重试次数（指数退避）
- `retryDelayMs`: 基础延迟毫秒
- `progressReportEvery`: 每 N 个文件播报一次进度（0=关闭）
- `downloadLimitKbps` / `uploadLimitKbps`: 限速（KB/s，0=不限制）

#### 群同步目标列表 `groupSyncTargets[]`

每个元素对应一个群的“可覆盖策略”。常用字段：

- `groupId`：群号（字符串）
- `enabled`：是否启用该群（定时/自动备份会受此影响）
- `sourceFolderId`：仅同步群文件树的某个文件夹（可选）
- `targetDir`：该群目标目录（为空则使用 `openlistTargetDir/<groupId>`）
- `flat`：覆盖默认平铺策略
- `maxFiles`：最多处理多少文件（0/空=不限制）
- `urlConcurrency` / `transferConcurrency` / `retryTimes` / `retryDelayMs` / `progressReportEvery` / `downloadLimitKbps` / `uploadLimitKbps`：逐项覆盖默认策略
- `uploadBackup`：是否启用“群文件上传事件自动备份”
- `timeWindows`：时段限制（仅用于定时任务/自动任务），例如 `00:00-06:00,23:00-23:59`
- 说明：`mode/fileTimeoutSec/schedule` 等字段已不再作为“命令可配置项”，且夜间自动备份采用固定策略（增量 + timeout=3000），保留字段仅用于兼容旧配置/历史数据。

#### 定时任务调度器 `scheduler`

用于统一管理“夜间自动备份（群文件 + oplts）”的后台调度：

- `enabled`：全局开关（false=关闭所有定时触发；不影响手动命令/事件）
- `tickCron`：调度器 cron（默认每天 02:00；支持 5/6 段，5 段会自动补 `秒=0`）
- `groupSync.enabled`：群文件夜间备份全局开关（会对 `uploadBackup=on` 的群执行一次同步）
- `opltNightly.enabled`：oplt 夜间自动备份全局开关（`#oplt夜间` 仅查看状态）

#### （可选）OpenList 备份默认传输方式

`#备份oplist` 的核心逻辑会读取一个“可选字段”作为默认传输方式（如果你愿意手工加到 config 里）：

- `openListBackupTransport`: `'auto' | 'webdav' | 'api'`

默认仍以指令参数 `--api/--webdav/--auto` 为准；如果不加该字段也不影响使用。

#### OpenList 转发规则 `openlistForwardRules[]`（二期新增）

用于“多源站 → 单目的端（固定为 openlistBaseUrl）”的 OpenList 转发规则列表，由主人私聊命令维护（见 `src/apps/ownerUi.ts`）。

常用字段（概要）：

- `id`：规则ID（短ID，便于手输）
- `name`：别名（可选）
- `sourceBaseUrl`：源 OpenList 地址
- `sourceUsername` / `sourcePassword`：源端账号（可选；未填按 guest 访问）
- `srcDir`：源目录（默认 `/`）
- `toDir`：目标根目录（默认 `openlistTargetDir`；实际会在其下按源域名创建子目录）
- `mode`：`full|incremental`（默认 `full`）
- `transport`：`auto|webdav|api`（默认 `auto`）
- `concurrency` / `scanConcurrency` / `perPage` / `timeoutSec`：执行参数（可选）
- `lastRunAt` / `lastResult`：最近一次执行记录（由插件写入）

### 5.3 WebUI 配置页

WebUI 配置入口由 `src/web.config.ts` 定义，主要能力：

- 展示并编辑 OpenList 信息、默认策略、群目标列表
- 保存时写入：`@karinjs/<插件名>/config/config.json`
- 做了一些“值兼容/归一化”（例如表单值可能包在 `{ value: ... }` 中、或 accordion 的 rows 结构）

仓库中提供了快照/截图：

- `webui-snapshot.txt`：WebUI a11y 快照（可用于查字段）
- `webui-plugin-config.png`：配置页截图

## 6. 指令与事件（对外行为）

> 以下均以 `src/apps/*` 的实际实现为准。

### 6.1 `#导出群文件`（私聊）

入口：`src/apps/groupFiles.ts`

- 触发：`/^#?(导出群文件|群文件导出)(.*)$/i`
- 权限：`permission: 'all'`
- 限制：仅私聊 `e.isPrivate === true`
- 输出：
  - 导出文件写入：`@karinjs/<插件名>/data/group-files-export/`
  - 同时会回复一段预览（最多 20 条、最多 10 条消息分片）

参数：

- `--csv`：输出 CSV（默认 JSON）
- `--no-url`：不解析 URL（仅导出文件元信息）
- `--url-only`：预览消息仅输出 URL（更方便复制）
- `--folder <id>`：从某个群文件夹开始递归
- `--max <n>`：限制导出条数
- `--concurrency <n>`：解析 URL 的并发（默认 3）
- `--send-file`：如果协议端支持 `bot.uploadFile`，尝试把导出文件直接发送出来

### 6.2 `#同步群文件`（私聊）

入口：`src/apps/groupFiles.ts` → `src/model/groupFiles/syncToOpenList.ts`

- 触发：`/^#?(同步群文件|群文件同步)(.*)$/i`
- 权限：`permission: 'all'`
- 限制：仅私聊（默认不在群聊触发，避免刷屏）
- 依赖：必须配置 `openlistBaseUrl/openlistUsername/openlistPassword`

参数（用于目录/平铺/并发/范围；模式与超时为固定策略）：

- `--to <dir>`：覆盖目标目录
- `--flat` / `--keep`：是否平铺（覆盖配置）
- `--folder <id>`：从指定群文件夹开始
- `--max <n>`：最多处理 n 个文件
- `--concurrency <n>`：同时覆盖 URL 并发与传输并发
- 固定策略：增量（incremental）+ 单文件超时 3000s（不再通过命令配置）

默认行为（容易踩坑的点）：

- 无论该群是否在 `groupSyncTargets` 中：同步模式固定为 **增量**（incremental）。
- 单文件超时固定 3000 秒；并发/平铺/限速等仍会按 `groupSyncTargets[groupId]` → `groupSyncDefaults` 兜底。

增量逻辑说明（见 `src/model/groupFiles/syncToOpenList.ts`）：

- 同步成功后，会把目标端 remotePath 写入状态文件 `group-file-sync-state/<groupId>.json`
- 下次增量同步会跳过“状态中判定为同一文件”的项（基于 md5/sha1，或 size+uploadTime 等启发式）

### 6.3 `#群同步配置`（主人权限）

入口：`src/apps/groupSyncConfig.ts` → `src/model/groupSync/configCommand.ts`

- 触发：`/^#?(群同步配置|同步群配置|群文件同步配置)(.*)$/i`
- 权限：`permission: 'master'`
- 作用：读写 `@karinjs/<插件名>/config/config.json` 中的 `groupSyncTargets`

常用子命令（详见 `src/model/groupSync/configCommand.ts` 的 help 文本）：

- `#群同步配置 列表`
- `#群同步配置 <群号> 查看`
- `#群同步配置 <群号> 添加` / `删除`
- `#群同步配置 <群号> 启用` / `停用`
- `#群同步配置 <群号> 目录 /目标目录`
- `#群同步配置 <群号> 平铺 开|关`
- `#群同步配置 <群号> uploadBackup on|off`
- `#群同步配置 <群号> 并发 <n>`（下载/上传并发）
- `#群同步配置 <群号> url并发 <n>`（解析URL并发）
- `#群同步配置 <群号> 重试 <n>`
- `#群同步配置 <群号> 时段 00:00-06:00,23:00-23:59`
（说明：夜间自动备份的 cron/mode/timeout 已固定，不再支持通过该命令配置。）

### 6.4 夜间自动备份调度（后台任务）

入口：`src/apps/scheduler.ts` → `src/model/groupSync/scheduler.ts` + `src/model/oplt/nightlyScheduler.ts`

- 任务：按 `config.scheduler.tickCron` 触发（默认：每天 02:00）
- 行为：
  1. 先执行群文件夜间备份：遍历 `groupSyncTargets`，对 `uploadBackup=on` 且未停用的群触发一次同步
  2. 再执行 oplts 夜间备份：遍历 oplts 列表依次备份
  3. 如果配置了 `timeWindows`，并且当前时间不在允许时段内，则跳过对应群
  4. 固定策略：先群后 oplts，统一增量（incremental），单文件超时 3000s
  5. 受全局开关控制：`config.scheduler.enabled` / `config.scheduler.groupSync.enabled` / `config.scheduler.opltNightly.enabled`

### 6.5 `#备份oplist`（OpenList → OpenList）

入口：`src/apps/groupFiles.backup.ts` → `src/model/openlist/backup.ts`

- 触发：`/^#?备份oplist(.*)$/i`
- 限制：仅私聊
- 目标端：使用本插件配置的 `openlistBaseUrl/openlistUsername/openlistPassword`
- 源端：当前实现默认 `guest`（即：**源端需要允许公开访问**；如需账号密码需二次开发）

用法示例：

- `#备份oplist https://pan.example.com --src / --to /backup`
- `#备份oplist https://pan.example.com --webdav`
- `#备份oplist https://pan.example.com --concurrency 3`
- `#备份oplist https://pan.example.com --scan 30 --per-page 2000`

参数：

- `--src <dir>`：源目录（默认 `/`）
- `--to <dir>`：目标根目录（默认使用 `openlistTargetDir`）
- 固定策略：增量（incremental）+ 单文件超时 3000s（不再通过命令配置）
- `--api` / `--webdav` / `--auto`：传输方式
  - `auto`：源端“下载偏向 API”、目标端“上传偏向 WebDAV”，失败会回退
- `--concurrency <n>`：复制并发（默认 3，上限 50）
- `--scan <n>`：扫描并发（默认 20，上限 200）
- `--per-page <n>`：API list 分页大小（默认 1000，上限 5000）
- `--max <n>`：最多处理 n 个文件（限制扫描后的列表长度）

目录策略：

- 最终目标目录会自动创建一个子目录：`<toDir>/<源域名(点转下划线)>/`，避免多个源站点混在一起。

### 6.6 群文件上传自动备份（事件）

入口：`src/apps/groupFiles.backup.ts` → `src/model/groupFiles/uploadAutoBackup.ts`

- 事件：`notice.groupFileUploaded`
- 开关：`groupSyncTargets[].uploadBackup === true` 且该群目标存在且未停用
- 并发策略：同一群的上传备份**串行排队**（Map 链式 promise），避免高并发写入 OpenList

重要实现细节：

- 事件 payload 期望包含：`fid/name/url()`（有些适配器可能缺失）
- 当事件自带 `url()` 不可用时：
  - 会尝试通过 `locateGroupFileByIdWithRetry()` 扫描群文件目录定位文件路径
  - 再通过 `resolveGroupFileUrl()` 重新获取下载 URL（兼容多种协议端接口）
- 目标端存在同名文件时：
  - 会自动尝试改名为 `_v1/_v2...` 直到成功或超出上限
- 成功后也会写入同步状态文件（复用 `group-file-sync-state/<groupId>.json`）

### 6.7 `#群文件帮助`（图片）

入口：`src/apps/help.ts`，模板：`resources/template/help.html`

- 触发：`/^#?(群文件帮助|同步群文件帮助|openlist帮助)$/i`
- 行为：渲染竖版帮助图（1080×1920，DPR 2）

注意（现状）：

- `help.html` 中的示例参数可能与真实解析参数存在差异（例如模板里出现 `--mode=full`；而当前实现为固定增量 + timeout=3000，且不再支持 `--full/--inc/--timeout`）。
- 建议后续同步修正模板内容，避免误导使用者。

### 6.8 主人私聊管理（图片面板，二期新增）

入口：`src/apps/ownerUi.ts`，模板：`resources/template/ui/*`

统一约束：

- 仅主人权限：`permission: 'master'`
- 仅私聊触发：`e.isPrivate === true`
- 输出为竖版图片（1080×1920 或多页分页），适合手机阅读

命令清单（概要）：

- `#群文件面板 [--help]`：输出管理总览面板（群绑定列表 + OP转发规则摘要 + 快捷命令）
- `#绑定备份群 <群号> [--to /目标目录] [--flat|--keep]`
  - 行为：写入/更新 `groupSyncTargets[groupId]`，并默认 `uploadBackup=on`
- `#解绑备份群 <群号>`：删除该群的 `groupSyncTargets` 条目
- `#开启群文件监听 <群号>`：将该群 `uploadBackup` 设为 `on`（若不存在群配置会自动创建）
- `#关闭群文件监听 <群号>`：将该群 `uploadBackup` 设为 `off`
- `#添加op转发 <源OpenListBaseUrl> [--src /] [--to /] [--name xxx] [--user u] [--pass p] [--full|--inc] [--auto|--api|--webdav]`
  - 行为：向 `openlistForwardRules[]` 追加规则（目的端固定为 `openlistBaseUrl`）
- `#op转发 列表|查看 <id>|执行 <id>|删除 <id>`：规则管理与执行（默认执行全量）

## 7. 数据落盘与文件格式

### 7.1 群文件导出文件

生成位置：`@karinjs/<插件名>/data/group-files-export/`

- 文件名：`group-files-<groupId>-<YYYYMMDD-HHmmss>.json|csv`
- JSON 格式结构（见 `src/model/groupFiles/export.ts`）：
  - `type`: `"group-files-export"`
  - `groupId`
  - `exportedAt` / `exportedAtText`
  - `folderId` / `maxFiles`
  - `total` / `withUrl` / `urlErrorsCount`
  - `list`: `ExportedGroupFile[]`
- CSV 表头：`path,name,fileId,size,uploadTime,uploaderId,uploaderName,md5,sha1,sha3,url,busid`

### 7.2 增量同步状态文件（核心）

位置：`@karinjs/<插件名>/data/group-file-sync-state/<groupId>.json`

结构（见 `src/model/groupFiles/types.ts`）：

- `version: 1`
- `groupId`
- `updatedAt`
- `lastSyncAt?`
- `files`: `Record<remotePath, { fileId?, size?, uploadTime?, md5?, sha1?, syncedAt }>`

用途：

- 增量同步（`mode=incremental`）用于判定“某个 remotePath 对应的文件是否已同步”
- 上传自动备份也会写入该状态（避免重复上传/便于后续增量跳过）

### 7.3 资源目录初始化

运行时资源目录：`@karinjs/<插件名>/resources/`

- `src/utils/resources.ts` 会把包内 `resources/` 复制过去
- 策略：只复制缺失文件；但 `template/` 下文件会覆盖（便于插件更新模板）

## 8. 关键实现细节（维护者必读）

### 8.1 群文件遍历与 URL 解析兼容层

相关文件：`src/model/groupFiles/qgroup.ts`

#### 获取群文件列表：`getGroupFileListCompat()`

会按“尽可能兼容不同适配器”的顺序尝试：

1. `bot._onebot.getGroupRootFiles()` / `bot._onebot.getGroupFilesByFolder()`
2. `bot.getGroupFileList(groupId, folderId)`
3. `bot.getGroupRootFiles(numberGroupId)` / `bot.getGroupFilesByFolder(numberGroupId, folderId)`

如果群号无法转为 number 且适配器不支持 `getGroupFileList`，会直接抛错。

#### 获取下载 URL：`resolveGroupFileUrl()`

会按顺序尝试：

1. `bot.getFileUrl(contact, fileId)`
2. `bot._onebot.nc_getFile(fileId)`
3. `bot._onebot.getGroupFileUrl(groupNum, fileId, busid?)`
4. 其它兼容接口（源码中还有额外 fallback）

> 结论：URL 获取失败通常是“适配器能力缺失/权限不足/URL 过期”，排障时优先看这里。

### 8.2 同步到 OpenList（WebDAV）的核心流程

相关文件：`src/model/groupFiles/syncToOpenList.ts`

流程（简化）：

1. 读取配置，校验 OpenList 目标端信息
2. `withGroupSyncLock(groupId)`：同一群只允许一个同步任务
3. 递归收集群文件列表 `collectAllGroupFiles`
4. 计算 remotePath（平铺 or 保留层级）
5. 增量模式：基于状态文件跳过已同步项
6. 并发解析 URL（`urlConcurrency`）
7. 并发传输（`transferConcurrency`，并且最大不超过 5）
   - 无配置限速时，会启用自适应并发（`runWithAdaptiveConcurrency`）
8. 成功写入状态文件，失败/URL失败会给出示例预览

传输实现：

- 创建目录：WebDAV `MKCOL`（`createWebDavDirEnsurer` 会逐级创建，且做了 promise 缓存避免重复）
- 上传：WebDAV `PUT`（`downloadAndUploadByWebDav`）
- 限速：`createThrottleTransform`（按 byte/s 对流做节流）
- 重试：单文件重试 `retryTimes + 1` 次，指数退避 `retryDelayMs * 2^(attempt-1)`
- URL 失效处理：当错误信息命中 `403/URL已过期/...` 会尝试重新获取 URL 再重试

### 8.3 定时调度的边界

相关文件：`src/model/groupSync/scheduler.ts`

注意点：

- tick 每秒跑一次，本身不做全局互斥；如果配置了多个群/多个 cron 同时命中，可能并行触发多组同步
- 同一群同步内部有锁（`withGroupSyncLock`），并发触发不会导致“同群重复上传”，但会产生“跳过日志”
- `timeWindows` 仅影响定时任务触发，不影响手动 `#同步群文件`

### 8.4 OpenList → OpenList 备份的限制与策略

相关文件：`src/model/openlist/backup.ts`

- 源端 token：当前实现固定为空字符串（guest）
  - 如果源端 OpenList 不公开，需要二次开发：支持源端用户名/密码并登录获取 token，或 WebDAV BasicAuth
- 目标端：
  - WebDAV 目标写入使用 `openlistUsername/openlistPassword` 的 BasicAuth
  - API 操作需要 token（通过 `/api/auth/login` 获取）
- 传输策略：
  - `auto`：目标端默认走 WebDAV 上传，失败后可能回退到 API（反之亦然）
  - 并发复制，增量模式会先检查目标端是否存在（HEAD 或 API pathExists）

## 9. 常见问题与排障

### 9.1 同步时报 401/403（WebDAV）

典型原因：

- `openlistUsername/openlistPassword` 错误
- OpenList 未开启 WebDAV
- 账号没有写入目标目录权限
- 目标目录不在用户可访问的挂载范围

建议：

1. 先用少量文件测试（`--max 1`）
2. 打开日志观察 `upload failed` 的 status 与响应体（`src/model/openlist/webdav.ts` 会附带部分提示）
3. 在 OpenList 侧确认 WebDAV 权限与目录 ACL

### 9.2 URL 过期/403/下载超时

群文件下载 URL 通常有时效：

- 手动导出：如果导出的 URL 过期，需要重新导出或重新解析
- 同步逻辑：在部分错误情况下会自动刷新 URL（仍可能失败）

建议：

- 单文件超时已固定为 3000s（如仍超时，优先降低并发/启用限速）
- 降低 `transferConcurrency`
- 低带宽环境启用限速（`downloadLimitKbps/uploadLimitKbps`），避免连接抖动

### 9.3 “当前适配器不支持获取群文件列表”

见 `getGroupFileListCompat()`：

- 适配器需要至少实现其一：`getGroupFileList` / `getGroupRootFiles` / `getGroupFilesByFolder`
- 某些接口要求群号可转 number

建议：

- 在运行时打印 bot 支持的方法（临时调试）
- 为当前协议端补一个适配层（优先在 `src/model/groupFiles/qgroup.ts` 集中处理）

### 9.4 同步任务提示“正在进行中”

这是正常的互斥保护（见 `withGroupSyncLock`）：

- 同一群只允许一个同步任务
- 定时触发与手动触发撞车时，后者会直接提示并退出

### 9.5 帮助图渲染失败

`#群文件帮助` 依赖 `@karinjs/plugin-puppeteer`（Chromium 环境）。

建议：

- 确认依赖已安装，且 puppeteer 能正常启动
- 如果部署环境缺少系统依赖（Linux 常见），需要按 puppeteer 官方文档安装依赖库

## 10. 后续开发建议（按当前代码的“最值钱”改进项）

1. **清理 demo apps**：把模板示例移到单独目录，或用配置开关控制是否注册
2. **修正帮助图参数**：让 `resources/template/help.html` 与 `src/apps/groupFiles.ts` 的真实参数一致
3. **OpenList 源端鉴权**：为 `#备份oplist` 增加 `--user/--pass` 或读取配置（目前源端仅 guest）
4. **更强的增量判定**：当前以 remotePath 为 key；若文件在群内改名/移动，会被当成新文件上传（可选增加“哈希目录”策略）
5. **补充测试**：优先给 `cronMatches/parseTimeWindows/normalizePosixPath` 等纯函数加单测
